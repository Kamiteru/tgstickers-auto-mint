# Архитектура системы

## Общая схема

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ PurchaseOrches- │────│ PaymentMethod    │────│ StickerdomAPI   │
│ trator          │    │ Factory          │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ Monitoring      │    │ Payment          │    │ RateLimiter     │
│ System          │    │ Strategies       │    │ Service         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Основные слои

### Слой оркестрации
- **PurchaseOrchestrator**: Координация покупок
- **PaymentMethodFactory**: Создание платежных стратегий
- **Мониторинг**: Отслеживание операций и метрик

### Слой стратегий
- **TONPaymentStrategy**: Blockchain платежи
- **TelegramStarsPayment**: Stars через Telethon API
- **Валидация**: Проверка данных и балансов

### Слой API
- **StickerdomAPI**: Единый интерфейс к API
- **EndpointManager**: Адаптивные эндпоинты с fallback
- **RateLimiterService**: Управление нагрузкой

### Слой данных
- **SQLite**: Persistent storage состояний
- **JSON файлы**: Конфигурация и кэш
- **Сессии**: Telegram авторизация

## Паттерны проектирования

### Strategy Pattern
Платежные методы реализованы как взаимозаменяемые стратегии:
- Единый интерфейс для всех методов оплаты
- Возможность параллельного выполнения
- Изолированное тестирование

### Factory Pattern
Создание стратегий через фабрику:
- Централизованная логика инициализации
- Конфигурируемость через переменные окружения
- Валидация доступности методов

### Circuit Breaker Pattern
Защита от каскадных сбоев:
- Автоматическое отключение проблемных эндпоинтов
- Постепенное восстановление
- Метрики производительности

## Потоки выполнения

### Основной поток покупки
1. **Получение команды** → Парсинг параметров
2. **Создание стратегий** → Валидация методов оплаты
3. **Параллельное выполнение** → Независимые покупки
4. **Агрегация результатов** → Уведомления

### Поток обработки ошибок
1. **Обнаружение ошибки** → Классификация типа
2. **Выбор стратегии** → Retry/Fallback/Circuit break
3. **Восстановление** → Повторная попытка или переключение
4. **Логирование** → Сохранение метрик

## Принципы масштабируемости

### Модульность
- Четкое разделение ответственности между компонентами
- Слабая связанность через интерфейсы
- Возможность независимого развития модулей

### Конфигурируемость
- Профили производительности для разных сценариев
- Гибкая настройка через переменные окружения
- Адаптивное поведение на основе условий

### Отказоустойчивость
- Множественные fallback механизмы
- Graceful degradation при сбоях компонентов
- Persistent storage критических данных

 