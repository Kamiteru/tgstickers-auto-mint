# Адаптивная система эндпоинтов

## Общая концепция

Адаптивная система эндпоинтов автоматически обнаруживает и адаптируется к изменениям в Stickerdom API. Система состоит из двух основных компонентов:

1. **EndpointManager** - быстрая валидация и fallback система для продакшена
2. **EndpointDiscovery** - полное обнаружение эндпоинтов через Selenium (фоновый режим)

## Компоненты системы

### EndpointManager
- Быстрая валидация через HEAD/OPTIONS запросы за 1-2 секунды
- Автоматическое переключение на резервные эндпоинты при сбоях
- Отслеживание состояния эндпоинтов с метриками производительности
- Сохранение состояния между запусками приложения

### EndpointDiscovery
- Selenium мониторинг для анализа реального трафика браузера
- Автоматическое обновление базы известных эндпоинтов
- Планировщик для работы в фоновом режиме каждые 12-24 часа

## Принцип работы

### Для дропов (максимальная скорость)
```python
# Мгновенная проверка лучшего эндпоинта
endpoint = await endpoint_manager.get_best_endpoint('purchase_ton')
# Быстрая покупка без задержек
result = await api.purchase_with_endpoint(endpoint)
```

### Для обновления базы (фоновый режим)
```python
# Полное обнаружение когда НЕТ активных дропов
discovered = await discovery.discover_endpoints()
# Обновление базы эндпоинтов
endpoint_manager.update_from_discovery(discovered)
```

## Конфигурация

### Переменные окружения
```env
# Включить адаптивную систему (по умолчанию: true)
ENDPOINT_VALIDATION_ENABLED=true

# Максимальное время на валидацию при старте в секундах (по умолчанию: 2.0)
ENDPOINT_VALIDATION_TIMEOUT=2.0

# Отключить headless режим браузера для отладки (по умолчанию: false)
SELENIUM_HEADLESS_DISABLED=false
```

### Автоматическое обнаружение
Система запускает обнаружение при следующих условиях:
- Health score любого типа операций < 50%
- Прошло более 24 часов с последней проверки
- Критические эндпоинты недоступны

## Поддерживаемые операции

### purchase_ton
```python
Эндпоинты:
- /api/v1/shop/buy/crypto (приоритет 1)
- /api/v1/shop/purchase/crypto (приоритет 2) 
- /api/v1/crypto/buy (приоритет 3)
```

### purchase_stars
```python
Эндпоинты:
- /api/v1/shop/buy (приоритет 1)
- /api/v1/shop/purchase (приоритет 2)
- /api/v1/stars/buy (приоритет 3)
```

### collection
```python
Эндпоинты:
- /api/v1/collection/{id} (приоритет 1)
- /api/v1/collections/{id} (приоритет 2)
- /api/v1/shop/collection/{id} (приоритет 3)
```

### price
```python
Эндпоинты:
- /api/v1/shop/price/crypto (приоритет 1)
- /api/v1/price/crypto (приоритет 2)
```

## Мониторинг

### Статистика эндпоинтов
```python
stats = endpoint_manager.get_endpoint_stats()
# Результат: {'purchase_ton': {'working': 1, 'total': 3, 'health_score': 0.27}}
```

### Логи
```
Validating endpoints...
   purchase_ton: 1 working endpoints
   purchase_stars: 1 working endpoints
   collection: 1 working endpoints
   price: 1 working endpoints
```

## Производительность

### Быстрый режим (для дропов)
- Валидация: 1-2 секунды для всех эндпоинтов
- Fallback: мгновенное переключение
- Overhead: < 0.1 секунды на запрос

### Полное обнаружение (фоновый режим)
- Время: 10-30 секунд
- Требования: Chrome браузер
- Частота: 1 раз в 12-24 часа

## Отладка

### Включить debug браузер
```env
SELENIUM_HEADLESS_DISABLED=true
```

### Просмотр статуса
```python
from services.endpoint_manager import get_endpoint_manager
manager = get_endpoint_manager()
print(manager.get_endpoint_stats())
```

## Преимущества

- Устойчивость к изменениям API через автоматическую адаптацию
- Минимальная задержка для критических операций (дропов)
- Интеллектуальный fallback с приоритетами и мониторингом состояния
- Автоматическое фоновое обновление базы эндпоинтов
- Полная обратная совместимость с существующим кодом

## Ограничения

- Требует установленный Chrome браузер для полного обнаружения
- Дополнительные зависимости: selenium, webdriver-manager
- Полное обнаружение занимает 10-30 секунд

## Заключение

Адаптивная система эндпоинтов решает проблему изменений API через гибридный подход:
- Быстрая валидация для критических операций (дропы)
- Умное долгосрочное обнаружение для стабильности
- Надежная fallback стратегия с множественными резервными вариантами

Система полностью интегрирована в существующий код и не требует изменений в логике покупок, обеспечивая прозрачную адаптацию к изменениям API Stickerdom. 